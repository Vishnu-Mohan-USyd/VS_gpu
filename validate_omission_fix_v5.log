/home/vysoforlife/miniconda3/envs/habitat/lib/python3.9/site-packages/scipy/__init__.py:146: UserWarning: A NumPy version >=1.17.3 and <1.25.0 is required for this version of SciPy (detected version 1.26.4
  warnings.warn(f"A NumPy version >={np_minversion} and <{np_maxversion}"
======================================================================
Phase B Omission Fix Validation
Protocol: Gavornik & Bear (2014) — 150ms elements, 800 presentations
======================================================================

======================================================================
Test 1: g_exc_ee trace recording
======================================================================
2026-02-27 22:48:08.874684: W external/xla/xla/service/platform_util.cc:199] unable to create StreamExecutor for CUDA:0: failed initializing StreamExecutor for CUDA device ordinal 0: INTERNAL: failed call to cuDevicePrimaryCtxRetain: CUDA_ERROR_OUT_OF_MEMORY: out of memory; total memory reported: 17170956288

  Test 1: EXCEPTION — Unable to initialize backend 'cuda': INTERNAL: no supported devices found for platform CUDA (you may need to uninstall the failing plugin package, or set JAX_PLATFORMS=cpu to skip this backend.)
Traceback (most recent call last):
  File "/home/vysoforlife/miniconda3/envs/habitat/lib/python3.9/site-packages/jax/_src/xla_bridge.py", line 879, in backends
    backend = _init_backend(platform)
  File "/home/vysoforlife/miniconda3/envs/habitat/lib/python3.9/site-packages/jax/_src/xla_bridge.py", line 970, in _init_backend
    backend = registration.factory()
  File "/home/vysoforlife/miniconda3/envs/habitat/lib/python3.9/site-packages/jax/_src/xla_bridge.py", line 668, in factory
    return xla_client.make_c_api_client(plugin_name, updated_options, None)
  File "/home/vysoforlife/miniconda3/envs/habitat/lib/python3.9/site-packages/jaxlib/xla_client.py", line 200, in make_c_api_client
    return _xla.get_c_api_client(plugin_name, options, distributed_client)
jaxlib.xla_extension.XlaRuntimeError: INTERNAL: no supported devices found for platform CUDA

During handling of the above exception, another exception occurred:

jax.errors.SimplifiedTraceback: For simplicity, JAX has removed its internal frames from the traceback of the following exception. Set JAX_TRACEBACK_FILTERING=off to include these.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/vysoforlife/code_files/und_OSI_formation_extend/Fold6_pvfix/validate_omission_fix.py", line 565, in main
    ok = test_trace_recording()
  File "/home/vysoforlife/code_files/und_OSI_formation_extend/Fold6_pvfix/validate_omission_fix.py", line 207, in test_trace_recording
    state, static = numpy_net_to_jax_state(net)
  File "/home/vysoforlife/code_files/und_OSI_formation_extend/Fold6_pvfix/./network_jax.py", line 211, in numpy_net_to_jax_state
    lgn_v=jnp.array(net.lgn.v, dtype=jnp.float32),
  File "/home/vysoforlife/miniconda3/envs/habitat/lib/python3.9/site-packages/jax/_src/numpy/lax_numpy.py", line 3214, in array
    out_array: Array = lax_internal._convert_element_type(
  File "/home/vysoforlife/miniconda3/envs/habitat/lib/python3.9/site-packages/jax/_src/lax/lax.py", line 559, in _convert_element_type
    return convert_element_type_p.bind(operand, new_dtype=new_dtype,
  File "/home/vysoforlife/miniconda3/envs/habitat/lib/python3.9/site-packages/jax/_src/core.py", line 416, in bind
    return self.bind_with_trace(find_top_trace(args), args, params)
  File "/home/vysoforlife/miniconda3/envs/habitat/lib/python3.9/site-packages/jax/_src/core.py", line 420, in bind_with_trace
    out = trace.process_primitive(self, map(trace.full_raise, args), params)
  File "/home/vysoforlife/miniconda3/envs/habitat/lib/python3.9/site-packages/jax/_src/core.py", line 921, in process_primitive
    return primitive.impl(*tracers, **params)
  File "/home/vysoforlife/miniconda3/envs/habitat/lib/python3.9/site-packages/jax/_src/dispatch.py", line 87, in apply_primitive
    outs = fun(*args)
RuntimeError: Unable to initialize backend 'cuda': INTERNAL: no supported devices found for platform CUDA (you may need to uninstall the failing plugin package, or set JAX_PLATFORMS=cpu to skip this backend.)

======================================================================
Test 4: Biological plausibility audit
======================================================================
  [OK] E→E STDP is pair-based with weight dependence
  [OK] Phase B uses only E→E STDP (no feedforward)
  [OK] Control condition uses novel orientation (22.5°)
  [OK] No global E→E weight renormalization
  [OK] Omission response averages over multiple evaluation trials

  Test 4 PASSED: No non-biological hacks detected

======================================================================
Test 5: Performance benchmark
======================================================================
  Warming up JIT...
  Timing 100 presentations (150ms elements, 1.5s ITI)...
    100 presentations: 3.30s (33.0ms/trial)
    Estimated 800 presentations: 26.4s (0.4min)

  Test 5 PASSED: Estimated 26.4s for 800 presentations

======================================================================
Test 2: F>R ratio (800 presentations, 150ms elements)
======================================================================

  Phase A (100 segments, JAX, seed=42)...
    Phase A: 50/100 segments done
    Phase A: 100/100 segments done
    Mean OSI after Phase A: 0.809
  Calibrating E→E drive (JAX)...
  [calibrate_jax] scale=1 → drive_frac=0.0001
  [calibrate_jax] scale=5 → drive_frac=0.0005
  [calibrate_jax] scale=20 → drive_frac=0.0019
  [calibrate_jax] scale=50 → drive_frac=0.0048
  [calibrate_jax] scale=100 → drive_frac=0.0096
  [calibrate_jax] scale=200 → drive_frac=0.0191
  [calibrate_jax] scale=500 → drive_frac=0.0499
  [calibrate_jax] scale=1000 → drive_frac=0.1586
  [calibrate_jax] scale=2000 → drive_frac=0.7173
  [calibrate_jax] refine scale=707.1 → drive_frac=0.0888
  [calibrate_jax] refine scale=840.9 → drive_frac=0.1148
  [calibrate_jax] refine scale=917.0 → drive_frac=0.1239
  [calibrate_jax] refine scale=957.6 → drive_frac=0.1315
  [calibrate_jax] WARNING: OSI=0.217 < floor=0.30 at scale=1000.0
  [calibrate_jax] back-off scale=957.6 → OSI=0.195, drive_frac=0.1315
  [calibrate_jax] back-off scale=917.0 → OSI=0.203, drive_frac=0.1239
  [calibrate_jax] back-off scale=840.9 → OSI=0.300, drive_frac=0.1148
  [calibrate_jax] Final: scale=840.9 → drive_frac=0.1148, OSI=0.300
    Calibration: scale=840.9, frac=0.1148
    w_e_e_max=3.3636 (2× cal mean=1.6818)

  [pres 0] F>R=1.0000 (fwd=1.681793, rev=1.681793)

  Phase B training (800 presentations, element_ms=150.0, iti_ms=1500.0)...
    [pres 100] F>R=1.0449 (fwd=1.568676, rev=1.501340), W_ee mean=1.54268 max=2.1771, elapsed=4.0s
    [pres 200] F>R=1.1180 (fwd=1.529567, rev=1.368102), W_ee mean=1.46046 max=2.5392, elapsed=7.5s
    [pres 400] F>R=1.2211 (fwd=1.495396, rev=1.224613), W_ee mean=1.38125 max=2.9620, elapsed=15.2s
    [pres 600] F>R=1.2325 (fwd=1.401653, rev=1.137238), W_ee mean=1.30772 max=2.9989, elapsed=22.8s
    [pres 800] F>R=1.2102 (fwd=1.363159, rev=1.126410), W_ee mean=1.28727 max=3.0711, elapsed=30.0s

  Training completed in 30.0s
  F>R trajectory: 1.000 → 1.045 → 1.118 → 1.221 → 1.233 → 1.210

  Test 2: EXCEPTION — F>R must exceed 1.5 after 800 presentations, got 1.2102
Traceback (most recent call last):
  File "/home/vysoforlife/code_files/und_OSI_formation_extend/Fold6_pvfix/validate_omission_fix.py", line 592, in main
    result = test_fr_ratio()
  File "/home/vysoforlife/code_files/und_OSI_formation_extend/Fold6_pvfix/validate_omission_fix.py", line 335, in test_fr_ratio
    assert final_ratio > 1.5, \
AssertionError: F>R must exceed 1.5 after 800 presentations, got 1.2102

======================================================================
Test 3: Omission response (conductance-based)
======================================================================

  Phase A (100 segments, JAX, seed=42)...
    Phase A: 50/100 segments done
    Phase A: 100/100 segments done
    Mean OSI after Phase A: 0.809
  Calibrating E→E drive (JAX)...
  [calibrate_jax] scale=1 → drive_frac=0.0001
  [calibrate_jax] scale=5 → drive_frac=0.0005
  [calibrate_jax] scale=20 → drive_frac=0.0019
  [calibrate_jax] scale=50 → drive_frac=0.0048
  [calibrate_jax] scale=100 → drive_frac=0.0096
  [calibrate_jax] scale=200 → drive_frac=0.0191
  [calibrate_jax] scale=500 → drive_frac=0.0499
  [calibrate_jax] scale=1000 → drive_frac=0.1586
  [calibrate_jax] scale=2000 → drive_frac=0.7173
  [calibrate_jax] refine scale=707.1 → drive_frac=0.0888
  [calibrate_jax] refine scale=840.9 → drive_frac=0.1148
  [calibrate_jax] refine scale=917.0 → drive_frac=0.1239
  [calibrate_jax] refine scale=957.6 → drive_frac=0.1315
  [calibrate_jax] WARNING: OSI=0.217 < floor=0.30 at scale=1000.0
  [calibrate_jax] back-off scale=957.6 → OSI=0.195, drive_frac=0.1315
  [calibrate_jax] back-off scale=917.0 → OSI=0.203, drive_frac=0.1239
  [calibrate_jax] back-off scale=840.9 → OSI=0.300, drive_frac=0.1148
  [calibrate_jax] Final: scale=840.9 → drive_frac=0.1148, OSI=0.300
    Calibration: scale=840.9, frac=0.1148
    w_e_e_max=3.3636 (2× cal mean=1.6818)

  Phase B training (800 presentations)...
    [pres 0] OMR conductance=0.000050, spikes=0.0
    [pres 200] OMR conductance=0.000020, spikes=0.0
    [pres 400] OMR conductance=-0.000008, spikes=0.0
    [pres 800] OMR conductance=0.001168, spikes=0.0

  Final omission response:
    Conductance (trained - control): 0.001168
    Trained g_exc_ee: 0.001604
    Control g_exc_ee: 0.000436
    Spike difference: 0.0

  OMR trajectory: 0.0001 → 0.0000 → -0.0000 → 0.0012

  Test 3 PASSED: Omission response is positive (0.001168)

======================================================================
SUMMARY
======================================================================
  [FAIL] Test 1: Trace recording
  [PASS] Test 4: Bio audit
  [PASS] Test 5: Benchmark
  [FAIL] Test 2: F>R ratio
  [PASS] Test 3: Omission response

Some tests FAILED!
